{% extends "Hausaufgaben/menu.html" %}

{% block title %} Wochen-Ansicht {% endblock %}

{% block content %}
    <div id="contentContainer" class="container-fluid" style="width: 1000px">
    </div>
{% endblock %}

{% block script %}
    <script>
    function getLang() {
      if (navigator.languages != undefined)
        return navigator.languages[0];
      return navigator.language;
    }
    const locale = getLang();
    function jsDayToNormal(day) {
        if (day === 0)
            return 6;
        else
            return day-1;
    }
    function normalToJsDay(day) {
        if (day === 6)
            return 0;
        else
            return day+1;
    }
    Date.prototype.getWeekNumber = function(){
        let d = new Date(this.getTime());
        let week1 = new Date(d.getFullYear(), 0, 1);
        if (week1.getDay() !== 1) {
            week1 = new Date(d.getFullYear(), 0, 8-jsDayToNormal(week1.getDay()));
        }
        return Math.floor(((d.getTime()-week1.getTime())/86400000/7))+1; // Misscalc
    };
    Date.prototype.getDayName = function () {
        let ret = this.toLocaleDateString(locale, { weekday: 'long' });
        return ret;
    }
    function expandTextarea(id1, id2) {
        document.getElementById(id1).addEventListener("shown.bs.modal", async function() {
            let textarea = document.getElementById(id2);
            textarea.style.overflow = 'hidden';
            textarea.style.height = 0;
            textarea.style.height = textarea.scrollHeight + 'px';
        }, false);
    }
    function getDateOfWeek(w, y) {
        let day1 = new Date(y, 0, 1);
        return new Date(y, 0, (7*w)-jsDayToNormal(day1.getDay())+1, 12);
    }

    django_data = {{ view_data|safe }};
    entries = [];
    weeks = {};
    let cur_week = parseInt(django_data.weekview_week);
    let cur_year = parseInt(django_data.weekview_year);

    class Entry {
        constructor(id, title, note, date, type, done, creator_id, creator_name) {
            this.id = id;
            this.title = title;
            this.note = note;
            this.date = date;
            this.dateString = `${this.date.getDate()}.${this.date.getMonth()+1}.${this.date.getFullYear()}`;
            this.week = this.date.getWeekNumber()
            this.type = type;
            this.done = done;
            this.creatorId = creator_id;
            this.creatorName = creator_name;
        }

        createDetails() {
            try {
                document.getElementById("entryModal" + this.id).remove();
            } catch(e) {}

            let buttonType = "danger";
            if (this.done)
                buttonType = "success";

            let modal = document.createElement("div");
            modal.className = "modal fade";
            modal.id = "entryModal" + this.id;
            modal.tabIndex = -1;
            modal.setAttribute("aria-hidden", "true")
            modal.innerHTML = `
<div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
        <div class="modal-header" style="padding: 10px 10px">
            <h5 class="modal-title">${this.title}</h5>
            <form action="{% url 'weekview' currently_viewed %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="type" value="changeEntryDone">
                <input type="hidden" name="entry" value="${this.id}">
                <input type="hidden" id="modalCheckCurWeek${this.id}" name="cur_week" value="${cur_week}">
                <input type="hidden" id="modalCheckCurYear${this.id}" name="cur_year" value="${cur_year}">

                <button type="submit" id="entryCheckButton${this.id}" class="btn btn-outline-${buttonType}" style="height: 30px; width: 30px; padding: 1px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                        <path d="M13.485 1.431a1.473 1.473 0 0 1 2.104 2.062l-7.84 9.801a1.473 1.473 0 0 1-2.12.04L.431 8.138a1.473 1.473 0 0 1 2.084-2.083l4.111 4.112 6.82-8.69a.486.486 0 0 1 .04-.045z"/>
                    </svg>
                </button>
            </form>
        </div>
        <div class="modal-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-2">
                        <span class="align-middle">Notiz</span>
                    </div>
                    <div class="col-10">
                        <textarea id="noteArea${this.id}" class="textarea-autosize" type="text" readonly aria-label="note1" style="resize: none">${this.note}</textarea>
                    </div>
                </div>

                <hr class="mt-2 mb-2">

                <div class="row">
                    <div class="col-lg-2">
                        <span class="align-middle">Datum</span>
                    </div>
                    <div class="col-3">
                        <input type="text" readonly aria-label="date${this.id}" value="${this.dateString}" style="width: 100px">
                    </div>
                    <div class="col-3">
                        <input type="text" readonly aria-label="date${this.id}" value="Woche ${this.week}" style="width: 100px">
                    </div>
                    <div class="col-4">
                        <input type="text" readonly aria-label="date${this.id}" value="${this.date.getDayName()}" style="width: 100%; align-self: end">
                    </div>
                </div>

                <hr class="mt-2 mb-2">

                <div class="row">
                    <div class="col-lg-2">
                        <span class="align-middle">Typ</span>
                    </div>
                    <div class="col-10">
                        <input type="text" readonly aria-label="type${this.id}" value="${this.type}" style="width: 100px">
                    </div>
                </div>

                <hr class="mt-2 mb-2">

                <div class="row">
                    <div class="col-lg-2">
                        <span class="align-middle">Ersteller</span>
                    </div>
                    <div class="col-10">
                        <input type="text" readonly aria-label="creator${this.id}" value="${this.creatorName}" style="width: 100px">
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer" style="padding: 10px 10px">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zur√ºck</button>
        </div>
    </div>
</div>`

            document.getElementById("contentContainer").insertAdjacentHTML("beforebegin", modal.outerHTML);
            expandTextarea(modal.id, `noteArea${this.id}`);
        }
    }
    function changeEntryDone(entry_id) {
        entries.forEach(function(entry) {
            if (entry.id === entry_id) {
                entry.done = !entry.done;
            }
        });
    }
    class Week {
        constructor(date) {
            this.dateStart = new Date();
            this.dateStart.setTime(date.getTime());
            this.dateStart.setDate(date.getDate()-date.getDay()+1);
            this.dateStart.setMonth(date.getMonth());
            this.dateEnd = new Date();
            this.dateEnd.setTime(date.getTime());
            this.dateEnd.setDate(date.getDate()-date.getDay()+7);
            this.weekNumber = this.dateStart.getWeekNumber();

            this.entries = [];

            this.createHTML();
        }

        addEntry(entry) {
            this.entries.push(entry);
        }

        createHTML() {
            let dayHTMLs = ["", "", "", "", "", "", ""];

            for (let i = 0; i < this.entries.length; i++) {
                let entry = this.entries[i];
                let buttonType = "danger";
                if (entry.done)
                    buttonType = "success";
                let html = `
<div class="row">
    <div class="col-11">
        <input type="button" data-bs-toggle="modal" data-bs-target="#entryModal${entry.id}" style="width: 100%; height: 30px; text-align: start" readonly id="entry${entry.id}" aria-label="Entry${entry.id}" value="${entry.title}">
    </div>
    <div class="col-1" style="padding: 1px 1px;">
        <form action="{% url 'weekview' currently_viewed %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="type" value="changeEntryDone">
            <input type="hidden" name="entry" value="${entry.id}">
            <input type="hidden" name="cur_week" value="${cur_week}">
            <input type="hidden" name="cur_year" value="${cur_year}">

            <button type="submit" id="entryCheckButton${entry.id}" class="btn btn-outline-${buttonType}" style="height: 30px; width: 30px; padding: 1px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                    <path d="M13.485 1.431a1.473 1.473 0 0 1 2.104 2.062l-7.84 9.801a1.473 1.473 0 0 1-2.12.04L.431 8.138a1.473 1.473 0 0 1 2.084-2.083l4.111 4.112 6.82-8.69a.486.486 0 0 1 .04-.045z"/>
                </svg>
            </button>
        </form>
    </div>
</div>
`

                entry.createDetails()

                dayHTMLs[entry.date.getDay()-1] += html;
            }

            this.weekHTML = `
<div class="row">
    <div class="col-2">
        <button class="btn btn-primary btn-circle btn-lg" onclick="prevWeek()" style="padding: 8px 8px">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
        </button>
    </div>
    <div class="col-8">
        <h1 style="text-align: center">Woche ${this.weekNumber}; ${this.dateStart.getDate()}.${this.dateStart.getMonth()+1}.${this.dateStart.getFullYear().toString().slice(-2)} - ${this.dateEnd.getDate()}.${this.dateEnd.getMonth()+1}.${this.dateEnd.getFullYear().toString().slice(-2)}</h1>
    </div>
    <div class="col-2" align="right">
        <button class="btn btn-primary btn-circle btn-lg" onclick="nextWeek()" style="padding: 8px 8px">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-arrow-right" viewBox="1 0 16 16">
                <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
            </svg>
        </button>
    </div>
</div>
<div class="row" style="height: 250px">
    <div class="col border border-dark">
        <h2>Montag</h2>
        ${dayHTMLs[0]}
    </div>
    <div class="col border border-dark">
        <h2>Donnerstag</h2>
        ${dayHTMLs[3]}
    </div>
</div>
<div class="row" style="height: 250px">
    <div class="col border border-dark">
        <h2>Dienstag</h2>
        ${dayHTMLs[1]}
    </div>
    <div class="col border border-dark">
        <h2>Freitag</h2>
        ${dayHTMLs[4]}
    </div>
</div>
<div class="row" style="height: 250px">
    <div class="col border border-dark">
        <h2>Mittwoch</h2>
        ${dayHTMLs[2]}
    </div>
    <div class="col border border-dark">
        <h2>Wochenende</h2>
        ${dayHTMLs[5]}
        ${dayHTMLs[6]}
    </div>
</div>
`
        }
        show() {
            let container = document.getElementById("contentContainer");
            container.innerHTML = this.weekHTML;
        }
    }
    function showWeek(weekNum=0, year=0) {
        if (weekNum === 0) {
            let curDate = new Date();
            weekNum = curDate.getWeekNumber();
        }
        if (year === 0) {
            let curDate = new Date();
            year = curDate.getFullYear();
        }
        if (Object.keys(weeks).includes(`${weekNum}.${year}`)) {
            weeks[`${weekNum}.${year}`].createHTML();
            weeks[`${weekNum}.${year}`].show();
        }
        else {
            let date = getDateOfWeek(weekNum, year);
            date.setHours(12)
            let week = new Week(date);
            week.show();
        }
        cur_week = weekNum;
        cur_year = year;
    }
    function prevWeek() {
        cur_week -= 1;
        if (cur_week <= 0) {
            cur_year -= 1;
            cur_week = new Date(cur_year, 11, 31, 12).getWeekNumber();
        }
        showWeek(cur_week, cur_year);
    }
    function nextWeek() {
        cur_week += 1;
        if (cur_week > 52) {
            cur_year += 1;
            cur_week = 1;
        }
        showWeek(cur_week, cur_year);
    }

    for (let i = 0; i < django_data.entries.length; i++) {
        let entry = django_data.entries[i];
        let date = new Date(entry.date);
        entries.push(new Entry(entry.id, entry.title, entry.note, date, entry.type, entry.done, entry.creator.id, entry.creator.username));
    }
    for (let i = 0; i < entries.length; i++) {
        let entry = entries[i];
        entry.createDetails();

        if (Object.keys(weeks).includes(`${entry.date.getWeekNumber()}.${entry.date.getFullYear()}`)) {
            let week = weeks[`${entry.date.getWeekNumber()}.${entry.date.getFullYear()}`];
            week.addEntry(entry)
        }
        else {
            let week = new Week(entry.date);
            week.addEntry(entry);
            weeks[`${week.weekNumber}.${week.dateStart.getFullYear()}`] = week;
        }
    }

    showWeek(cur_week, cur_year);

    </script>
{% endblock %}